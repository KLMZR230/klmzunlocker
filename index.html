<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>KLMZ UNLOCKER - Pedidos Funcionales</title>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --dark-bg: #161a20;Â 
Â  Â  Â  Â  Â  Â  --header-bg: #11141a;Â 
Â  Â  Â  Â  Â  Â  --text-light: #ffffff;
Â  Â  Â  Â  Â  Â  --text-muted: #aaaaaa;
Â  Â  Â  Â  Â  Â  --accent-pink: #d9429c;Â 
Â  Â  Â  Â  Â  Â  --service-box-bg: #1c2025;Â 
Â  Â  Â  Â  Â  Â  --button-bg: #4a4a58;Â 
Â  Â  Â  Â  Â  Â  --whatsapp-green: #25d366;Â 
Â  Â  Â  Â  Â  Â  --card-border: #292d34;
Â  Â  Â  Â  Â  Â  --card-inner-bg: #1a1e25;Â 
Â  Â  Â  Â  Â  Â  --green-check: #00ff00;Â 
Â  Â  Â  Â  Â  Â  --red-error: #f44336;
Â  Â  Â  Â  Â  Â  --orange-pending: #ff9800;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilos Globales */
Â  Â  Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; }
Â  Â  Â  Â  body { background-color: var(--dark-bg); color: var(--text-light); font-size: 14px; }
Â  Â  Â  Â  a { color: var(--text-light); text-decoration: none; transition: color 0.2s; }
Â  Â  Â  Â  a:hover { color: var(--accent-pink); }
Â  Â  Â  Â  .top-info-bar { background-color: var(--header-bg); display: flex; justify-content: flex-end; align-items: center; padding: 8px 30px; font-size: 12px; border-bottom: 1px solid #292d34; }
Â  Â  Â  Â  .top-info-bar .info-group a { margin-left: 20px; padding: 5px 10px; border-radius: 3px; background-color: var(--button-bg); color: white; font-weight: bold; text-transform: uppercase; }
Â  Â  Â  Â  .top-info-bar .contact-info { color: var(--text-muted); margin-right: 20px; }
Â  Â  Â  Â  .main-nav { background-color: var(--header-bg); display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; }
Â  Â  Â  Â  .logo { font-size: 24px; font-weight: bold; color: var(--text-light); }
Â  Â  Â  Â  .logo .klmz { color: #4dc2f2; }
Â  Â  Â  Â  .nav-links { display: flex; align-items: center; }
Â  Â  Â  Â  .nav-links > a, .nav-item { margin-left: 25px; font-weight: 500; padding: 10px 0; text-transform: uppercase; cursor: pointer; position: relative; }Â 
Â  Â  Â  Â  .nav-item::after { content: ' â–¼'; font-size: 8px; margin-left: 5px; }
Â  Â  Â  Â  #loginLogoutBtn { background-color: #3b3b3b; padding: 5px 15px; border-radius: 5px; margin-left: 30px; border: 1px solid #454545; cursor: pointer; }
Â  Â  Â  Â  .hero-section {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: flex-end;Â 
Â  Â  Â  Â  Â  Â  padding: 60px 50px 0px 50px;Â 
Â  Â  Â  Â  Â  Â  min-height: 500px;Â 
Â  Â  Â  Â  Â  Â  height: 70vh;Â 
Â  Â  Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  background-size: cover;Â 
Â  Â  Â  Â  Â  Â  background-position: center bottom;Â 
Â  Â  Â  Â  Â  Â  background-color: var(--dark-bg);
Â  Â  Â  Â  Â  Â  background-image: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .services-content { flex-basis: 40%; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 80px; z-index: 10; }
Â  Â  Â  Â  .services-box { background-color: var(--service-box-bg); border-radius: 10px; padding: 25px 30px; margin-bottom: 30px; width: 90%; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); border: 3px solid var(--accent-pink); border-radius: 50px / 10px; display: flex; flex-direction: column; align-items: flex-start; }
Â  Â  Â  Â  .services-title { background-color: #000; color: var(--text-light); font-size: 20px; font-weight: bold; padding: 10px 20px; margin-top: -45px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; margin-left: -10px; border: 2px solid var(--accent-pink); }
Â  Â  Â  Â  .service-item { display: flex; align-items: center; margin-top: 20px; font-size: 16px; font-weight: bold; letter-spacing: 0.5px; }
Â  Â  Â  Â  .service-item::before { content: 'ï£¿'; font-size: 18px; color: var(--accent-pink); margin-right: 5px; }
Â  Â  Â  Â  #mainDevicesImage { position: absolute; bottom: 0; right: 0; width: 60%; max-width: 900px; height: auto; object-fit: contain; z-index: 1; }
Â  Â  Â  Â  .site-footer { background-color: #1a1e25; padding: 50px 30px 20px 30px; display: flex; flex-direction: column; border-top: 1px solid #292d34; }
Â  Â  Â  Â  .footer-bottom { border-top: 1px solid #292d34; padding-top: 20px; text-align: center; font-size: 12px; color: var(--text-muted); }
Â  Â  Â  Â  .chat-buttons { position: fixed; bottom: 20px; right: 20px; z-index: 101; display: flex; flex-direction: column; gap: 15px; }
Â  Â  Â  Â  .chat-button {Â 
Â  Â  Â  Â  Â  Â  width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); cursor: pointer; overflow: hidden;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-button.whatsapp { background-color: var(--whatsapp-green); text-decoration: none; border: none; }
Â  Â  Â  Â  .chat-button.whatsapp img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }

Â  Â  Â  Â  .admin-section { max-width: 1000px; }
Â  Â  Â  Â  .admin-section, .login-section { background-color: #22252a; border-radius: 8px; padding: 30px; margin: 50px auto; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); text-align: center; }
Â  Â  Â  Â  .admin-section h3, .login-section h3 { margin-bottom: 25px; color: var(--text-light); font-size: 24px; }
Â  Â  Â  Â  .admin-section input, .login-section input { display: block; width: calc(100% - 20px); padding: 12px; margin: 15px auto; border-radius: 5px; border: 1px solid #444; background-color: #333; color: white; font-size: 16px; }
Â  Â  Â  Â  .admin-section button, .login-section button { background-color: var(--accent-pink); color: white; padding: 12px 25px; border: none; cursor: pointer; font-weight: bold; border-radius: 5ps; font-size: 16px; transition: background-color 0.2s; margin-top: 15px; }
Â  Â  Â  Â  .admin-options { text-align: left; margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }
Â  Â  Â  Â  .admin-options h4 { font-size: 20px; margin-bottom: 15px; color: var(--text-light); }
Â  Â  Â  Â  .admin-options .form-container { margin-top: 20px; background-color: #1c2025; padding: 20px; border-radius: 8px; }
Â  Â  Â  Â  .admin-options .form-container button { background-color: #4c4e97; }
Â  Â  Â  Â  .form-message { margin-top: 15px; font-size: 14px; color: yellow; }
Â  Â  Â  Â  .hidden { display: none !important; }

Â  Â  Â  Â  /* Estilo para el Dropdown de Poner Orden */
Â  Â  Â  Â  .dropdown-menu {
Â  Â  Â  Â  Â  Â  position: absolute; top: 100%; left: 50%; transform: translateX(-50%); min-width: 350px; background-color: var(--header-bg); border: 1px solid #333; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); z-index: 20; padding: 10px 0; list-style: none; text-align: left; text-transform: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dropdown-menu li a { display: block; padding: 8px 15px; color: var(--text-light); font-weight: normal; }
Â  Â  Â  Â  .dropdown-menu li a:hover { background-color: #22252a; color: var(--accent-pink); }

Â  Â  Â  Â  /* --- ESTILOS DE SECCIONES INTERNAS --- */
Â  Â  Â  Â  #imeiServiceSection, #boxDongleServiceSection, #digitalRentServiceSection, #clientOrderHistorySection { padding: 40px 50px; background-color: var(--dark-bg); }
Â  Â  Â  Â  #imeiServiceSection h2, #boxDongleServiceSection h2, #digitalRentServiceSection h2, #clientOrderHistorySection h2 { margin-bottom: 30px; color: var(--accent-pink); font-size: 28px; border-bottom: 2px solid var(--card-border); padding-bottom: 10px; }
Â  Â  Â  Â  .service-grid {Â 
Â  Â  Â  Â  Â  Â  display: grid;Â 
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));Â 
Â  Â  Â  Â  Â  Â  gap: 20px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .service-card { cursor: pointer; background-color: var(--card-inner-bg); border: 1px solid #333; border-radius: 8px; padding: 15px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; justify-content: space-between; position: relative; }
Â  Â  Â  Â  .service-card h3 { font-size: 16px; color: var(--text-light); margin-bottom: 5px; line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start; }
Â  Â  Â  Â  .service-card .new-tag { color: var(--accent-pink); font-size: 11px; font-weight: bold; margin-left: 10px; }
Â  Â  Â  Â  .card-details { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; }
Â  Â  Â  Â  .card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: none; font-weight: bold; }
Â  Â  Â  Â  .card-footer .price { font-size: 14px; color: #ff9800; }
Â  Â  Â  Â  .card-footer .time { font-size: 14px; color: #ff9800; }
Â  Â  Â  Â  .card-icon-check { color: var(--green-check); font-size: 1.2em; margin-left: 5px; }

Â  Â  Â  Â  /* Estilos del Editor de Servicios */
Â  Â  Â  Â  .service-editor-list { list-style: none; padding: 0; }
Â  Â  Â  Â  .service-editor-list li {Â 
Â  Â  Â  Â  Â  Â  background-color: #1c2025; border: 1px solid #333; margin-bottom: 10px; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .service-editor-list li input { display: block; margin: 5px 0; background-color: #2e353f; border: 1px solid #444; padding: 4px; border-radius: 3px; color: white; font-size: 12px; }
Â  Â  Â  Â  .service-editor-list li .input-group { display: flex; flex-direction: column; margin-right: 10px; flex-shrink: 0; }
Â  Â  Â  Â  .service-editor-list li .input-group p { font-size: 10px; color: #aaa; margin-bottom: 2px; }
Â  Â  Â  Â  .service-editor-list li .full-name-input { width: 95%; }Â 
Â  Â  Â  Â  .service-editor-list li .service-editor-actions { margin-left: auto; }
Â  Â  Â  Â  .service-editor-list button { background-color: var(--red-error); font-size: 12px; padding: 5px 10px; margin-top: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Estilos para el Historial de Pedidos */
Â  Â  Â  Â  .order-history-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
Â  Â  Â  Â  .order-card {Â 
Â  Â  Â  Â  Â  Â  background-color: #1a1e25;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  border-left: 5px solid gray;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: space-between;Â 
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease-in-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Colores de Estado de Pedidos */
Â  Â  Â  Â  .order-card.Exitoso {Â 
Â  Â  Â  Â  Â  Â  border-left-color: var(--whatsapp-green);Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(37, 211, 102, 0.2);Â 
Â  Â  Â  Â  Â  Â  background-color: #1a251f;
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-card.Pendiente {Â 
Â  Â  Â  Â  Â  Â  border-left-color: var(--orange-pending);Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(255, 152, 0, 0.2);Â 
Â  Â  Â  Â  Â  Â  background-color: #25231a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-card.Rechazado {Â 
Â  Â  Â  Â  Â  Â  border-left-color: var(--red-error);Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(244, 67, 54, 0.2);Â 
Â  Â  Â  Â  Â  Â  background-color: #251a1a;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .order-details p { margin: 2px 0; }
Â  Â  Â  Â  .order-actions { text-align: right; }
Â  Â  Â  Â  /* FIX: Asegurar que el select llama a la funciÃ³n global */
Â  Â  Â  Â  .order-actions select { padding: 5px; border-radius: 3px; background-color: #333; color: white; border: 1px solid #555; cursor: pointer; margin-bottom: 5px; }
Â  Â  Â  Â  .order-actions .admin-order-buttons { display: flex; flex-direction: column; align-items: flex-end; }
Â  Â  Â  Â  .order-actions .admin-order-buttons button { margin-top: 5px; background-color: var(--red-error); color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }

Â  Â  Â  Â  /* Estilo del Badge de Estado */
Â  Â  Â  Â  .status-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  padding: 3px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-badge.Exitoso { background-color: var(--whatsapp-green); color: black; }
Â  Â  Â  Â  .status-badge.Pendiente { background-color: var(--orange-pending); color: black; }
Â  Â  Â  Â  .status-badge.Rechazado { background-color: var(--red-error); color: white; }


Â  Â  Â  Â  /* Modal Styles - Mejorado */
Â  Â  Â  Â  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
Â  Â  Â  Â  .modal-content {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(145deg, #1c2025, #22252a);
Â  Â  Â  Â  Â  Â  padding: 40px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;Â 
Â  Â  Â  Â  Â  Â  max-width: 450px;Â 
Â  Â  Â  Â  Â  Â  width: 90%;Â 
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content h3 {Â 
Â  Â  Â  Â  Â  Â  color: var(--accent-pink);Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 25px;Â 
Â  Â  Â  Â  Â  Â  font-size: 22px;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #333;
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content input {Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background-color: #2e353f;
Â  Â  Â  Â  Â  Â  border: 1px solid #444;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Estilos especÃ­ficos para los campos requeridos en el modal */
Â  Â  Â  Â  .modal-content input.required-field {
Â  Â  Â  Â  Â  Â  border: 1px solid #555;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-content button {Â 
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, transform 0.1s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content button:active { transform: scale(0.98); }
Â  Â  Â  Â  .modal-content #submitModalOrder { background-color: var(--whatsapp-green); color: black; }
Â  Â  Â  Â  .modal-content #closeModal { background-color: #4a4a58; color: white; }
Â  Â  Â  Â  .modal-footer-actions { margin-top: 20px; display: flex; justify-content: space-around; }
Â  Â  Â  Â  .modal-serial-input {Â 
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  background-color: #161a20;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #4a4a58;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-serial-input p { font-size: 12px; color: var(--text-muted); margin-bottom: 5px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Estilo para el nuevo formulario de aÃ±adir servicio */
Â  Â  Â  Â  #newServiceForm {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #newServiceForm input {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  #newServiceForm label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-muted);
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  #newServiceForm .full-width {
Â  Â  Â  Â  Â  Â  grid-column: span 2;
Â  Â  Â  Â  }
Â  Â  Â  Â  #addServiceButton {
Â  Â  Â  Â  Â  Â  grid-column: span 2;
Â  Â  Â  Â  Â  Â  background-color: var(--whatsapp-green) !important;
Â  Â  Â  Â  Â  Â  color: black !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilo para el mensaje de administraciÃ³n */
Â  Â  Â  Â  #adminOrderHistoryMessage {Â 
Â  Â  Â  Â  Â  Â  text-align: left;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  background-color: #2e353f;
Â  Â  Â  Â  Â  Â  border-left: 3px solid var(--accent-pink);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <div class="top-info-bar">
Â  Â  Â  Â  <div class="info-group">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <nav class="main-nav">
Â  Â  Â  Â  <div class="logo">
Â  Â  Â  Â  Â  Â  <span class="klmz">KLMZ</span> UNLOCKER
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="nav-links">
Â  Â  Â  Â  Â  Â  <div class="nav-item" id="navAreaCliente">Area del Cliente</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="nav-item" id="navPongaOrden">
Â  Â  Â  Â  Â  Â  Â  Â  Ponga la orden
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-menu hidden" id="pongaOrdenMenu">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" class="order-type-link" data-service-type="imei">IMEI Service</a></li>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" class="order-type-link" data-service-type="box-dongle">Box/Dongle/Tool/Credit - Activation</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" class="order-type-link" data-service-type="digital-rent">Digital Tool Rent & Remote Service</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="nav-item" id="navHistorialPedidos">Historial de pedidos</div>

Â  Â  Â  Â  Â  Â  <div class="nav-item hidden" id="navAdminPanel">Panel de AdministraciÃ³n</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <span id="adminNameDisplay" class="hidden" style="margin-left: 25px; font-weight: bold; color: yellow;"></span>
Â  Â  Â  Â  Â  Â  <a href="#" id="loginLogoutBtn">Login / Register</a>
Â  Â  Â  Â  </div>
Â  Â  </nav>

Â  Â  <main>
Â  Â  Â  Â  <div class="modal hidden" id="orderModal">
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="modalServiceName">Realizar Nuevo Pedido</h3>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="modalClientName" placeholder="Tu Nombre Completo" class="required-field" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="modalWhatsapp" placeholder="NÃºmero de WhatsApp (Ej: +50377778888)" class="required-field" required>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-serial-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Ingrese el SN/IMEI para este servicio:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="modalSerial" placeholder="NÃºmero de Serie (SN/IMEI)" class="required-field" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="modalEmail" placeholder="Correo ElectrÃ³nico de Contacto" readonly>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="modalServiceId">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="modalServiceType"> <div class="modal-footer-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="submitModalOrder">Confirmar Pedido</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="closeModal">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="modalMessage" class="form-message"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <section class="hidden" id="imeiServiceSection">
Â  Â  Â  Â  Â  Â  <h2>IMEI Service</h2>
Â  Â  Â  Â  Â  Â  <div id="imeiServiceGridContainer" class="service-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="loadingMessageIMEI">Cargando servicios...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <section class="hidden" id="boxDongleServiceSection">
Â  Â  Â  Â  Â  Â  <h2>Box/Dongle/Tool/Credit - Activation</h2>
Â  Â  Â  Â  Â  Â  <div id="boxDongleServiceGridContainer" class="service-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="loadingMessageBoxDongle">Cargando servicios...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <section class="hidden" id="digitalRentServiceSection">
Â  Â  Â  Â  Â  Â  <h2>Digital Tool Rent & Remote Service</h2>
Â  Â  Â  Â  Â  Â  <div id="digitalRentServiceGridContainer" class="service-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="loadingMessageDigitalRent">Cargando servicios...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section class="hidden" id="clientOrderHistorySection">
Â  Â  Â  Â  Â  Â  <h2>ğŸ“œ Mi Historial de Pedidos</h2>
Â  Â  Â  Â  Â  Â  <div id="clientOrderHistoryContainer" class="order-history-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <p>Cargando sus pedidos...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <section class="hero-section" id="heroSection">
Â  Â  Â  Â  Â  Â  <div class="services-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="services-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="services-title">IPHONE SERVICES</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="service-item">IPHONE CARRIER UNLOCK</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="service-item">IPHONE ICLOUD UNLOCK</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="service-item">IPHONE ICLOUD BYPASS WITH SIM WORKING</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="service-item">IPHONE MDM BYPASS SERVICE</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <img id="mainDevicesImage" src="" alt="Dispositivos Apple">
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <section class="login-section hidden" id="loginSection">
Â  Â  Â  Â  Â  Â  <h3>Iniciar SesiÃ³n / Registrarse</h3>
Â  Â  Â  Â  Â  Â  <input type="email" id="loginEmail" placeholder="Email">
Â  Â  Â  Â  Â  Â  <input type="password" id="loginPassword" placeholder="ContraseÃ±a">
Â  Â  Â  Â  Â  Â  <button id="signInButton">Iniciar SesiÃ³n</button>
Â  Â  Â  Â  Â  Â  <button id="signUpButton">Registrarse</button>
Â  Â  Â  Â  Â  Â  <p id="loginMessage" class="form-message" style="color: red;"></p>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <section class="admin-section hidden" id="adminSection">
Â  Â  Â  Â  Â  Â  <h3>Panel de AdministraciÃ³n</h3>
Â  Â  Â  Â  Â  Â  <p>Bienvenido, <span id="loggedInUserName" style="font-weight: bold; color: yellow;">Admin</span>! (klmzr230@gmail.com)</p>

Â  Â  Â  Â  Â  Â  <div class="admin-options">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>GestiÃ³n de Ã“rdenes</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: #4dc2f2; border-bottom: 1px solid #444; padding-bottom: 10px;">Historial de Pedidos (TODOS)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="adminOrderHistoryMessage"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="adminOrderHistory" class="order-history-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Cargando pedidos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="admin-options" style="margin-top: 30px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>âš™ï¸ Editar Tarjetas de Servicios</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--accent-pink);">Seleccionar CategorÃ­a a Editar:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="serviceCategorySelector" style="width: 100%; padding: 10px; margin-bottom: 15px; background-color: #333; color: white; border-radius: 4px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="imei">IMEI Service</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="box-dongle">Box/Dongle/Tool/Credit - Activation</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="digital-rent">Digital Tool Rent & Remote Service</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="editorMessage" class="form-message"></p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="border-top: 1px solid #333; padding-top: 15px; margin-top: 15px; color: #25d366;">â• AÃ±adir Nuevo Servicio RÃ¡pido</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="newServiceForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="full-width">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="newServiceName">Nombre Completo del Servicio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newServiceName" placeholder="Ej: FRPFILE A12+ Bypass iPhone XR To 17ProMax (Windows Tool) OFFER âœ…" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="newServicePrice">Precio (Ej: $5.00):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newServicePrice" placeholder="$5" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="newServiceTime">Tiempo (Ej: Miniutes, 1-7 days):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newServiceTime" placeholder="Miniutes" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="full-width">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="newServiceCategory">Sub-CategorÃ­a (Ej: Hello A12+ iCloud Bypass Windows Tool):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newServiceCategory" placeholder="CategorÃ­a del servicio" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="addServiceButton">AÃ±adir Servicio a <span id="currentCategoryAddBtn">IMEI Service</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="addServiceMessage" class="form-message"></p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="border-top: 1px solid #333; padding-top: 15px; margin-top: 15px;">Lista de EdiciÃ³n</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="serviceEditorList" class="service-editor-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="saveServiceChanges" style="background-color: #4c4e97; margin-top: 15px;">Guardar Cambios y Sincronizar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="clearAllServicesButton" style="background-color: #f44336; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸš¨ Eliminar TODOS los Servicios de la CategorÃ­a Activa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="admin-options" style="margin-top: 30px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>GestiÃ³n de ImÃ¡genes (Solo Admin)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“¸ Subir Imagen de Fondo (Hero)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="backgroundImageFile" accept="image/*">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="uploadBackgroundButton">Subir Fondo</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="backgroundResponseMessage" class="form-message"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="clearBackgroundButton" style="background-color: #666; margin-top: 10px;">Limpiar Fondo</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-container" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ–¼ï¸ Cambiar Imagen de Dispositivos (Hero)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="devicesImageFile" accept="image/*">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="uploadDevicesButton">Subir Imagen de Dispositivos</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="devicesImageResponseMessage" class="form-message"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="clearDevicesButton" style="background-color: #666; margin-top: 10px;">Restaurar Imagen por Defecto</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </section>
Â  Â  </main>
Â  Â Â 
Â  Â  <footer class="site-footer">
Â  Â  Â  Â  <div class="footer-bottom">
Â  Â  Â  Â  Â  Â  &copy; 2025 KLMZ Unlocker. Todos los derechos reservados. Desarrollado por Freddy Granados.
Â  Â  Â  Â  </div>
Â  Â  </footer>
Â  Â Â 
Â  Â  <div class="chat-buttons">
Â  Â  Â  Â  <a href="https://wa.me/50368957466" class="chat-button whatsapp" target="_blank" title="WhatsApp: +503 689957466">
Â  Â  Â  Â  Â  Â  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon">
Â  Â  Â  Â  </a>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // ğŸ”‘ TUS CLAVES SUPABASE (INSERTADAS)
Â  Â  Â  Â  const SUPABASE_URL = 'https://suedecrtpmfgblzfcdhv.supabase.co';Â 
Â  Â  Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1ZWRlY3J0cG1mZ2JsemZjZGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MTI1NDUsImV4cCI6MjA3ODI4ODU0NX0.pQbqJTZgc2xMpd9cZH-sOnS-6wfGp-qUGv0938kr3UQ';
Â  Â  Â  Â  const ADMIN_EMAIL = 'klmzr230@gmail.com';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // DECLARACIONES GLOBALES
Â  Â  Â  Â  let supabase;
Â  Â  Â  Â  let heroSection, mainDevicesImage, loginSection, adminSection, imeiServiceSection, boxDongleServiceSection, digitalRentServiceSection, clientOrderHistorySection;Â 
Â  Â  Â  Â  let loginLogoutBtn;
Â  Â  Â  Â  let loggedInUserName, adminNameDisplay;
Â  Â  Â  Â  let backgroundResponseMessage, devicesImageResponseMessage, loginMessage, loadingMessage, editorMessage, addServiceMessage, adminOrderHistoryMessage;
Â  Â  Â  Â  let navAreaCliente, navPongaOrden, navHistorialPedidos, pongaOrdenMenu, navAdminPanel, adminOrderHistory, clientOrderHistoryContainer;

Â  Â  Â  Â  const BACKGROUND_BUCKET_NAME = 'background-images';Â 
Â  Â  Â  Â  const DEVICES_IMAGE_BUCKET_NAME = 'devices-images';Â 
Â  Â  Â  Â  const DEFAULT_DEVICES_IMAGE_URL = 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/IPhone_13_Pro.png/300px-IPhone_13_Pro.png';Â 
Â  Â  Â  Â  const BACKGROUND_FILE_PATH = 'hero_background.jpg';
Â  Â  Â  Â  const DEVICES_FILE_PATH = 'main_devices.png';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // IDs para las 3 categorÃ­as de servicio en la tabla 'store_services'
Â  Â  Â  Â  const SERVICE_TYPES = {
Â  Â  Â  Â  Â  Â  'imei': { id: 1, title: 'IMEI Service' },
Â  Â  Â  Â  Â  Â  'box-dongle': { id: 2, title: 'Box/Dongle/Tool/Credit - Activation' },
Â  Â  Â  Â  Â  Â  'digital-rent': { id: 3, title: 'Digital Tool Rent & Remote Service' }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Almacenamiento local de datos: Object para las 3 listas
Â  Â  Â  Â  let serviceDataStore = {
Â  Â  Â  Â  Â  Â  'imei': [],
Â  Â  Â  Â  Â  Â  'box-dongle': [],
Â  Â  Â  Â  Â  Â  'digital-rent': []
Â  Â  Â  Â  };

Â  Â  Â  Â  // Variable para rastrear quÃ© categorÃ­a se estÃ¡ editando
Â  Â  Â  Â  let currentEditingCategory = 'imei';Â 

Â  Â  Â  Â  // VARIABLE GLOBAL CRÃTICA PARA EL ESTADO DE SESIÃ“N INSTANTÃNEA
Â  Â  Â  Â  let currentUser = null;Â 

Â  Â  Â  Â  // --- FUNCIONES DE MENSAJERÃA ---

Â  Â  Â  Â  function displayAdminMessage(message, color = 'var(--red-error)', isError = true) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('adminOrderHistoryMessage');
Â  Â  Â  Â  Â  Â  if (container) {
Â  Â  Â  Â  Â  Â  Â  Â  container.style.color = color;
Â  Â  Â  Â  Â  Â  Â  Â  container.style.borderColor = color;
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<p>${isError ? 'âŒ ERROR RLS/API: ' : 'âœ… INFORMACIÃ“N: '}${message}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  if (!isError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mantener mensajes informativos (no error) visibles por 5 segundos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (container.innerHTML.includes(message)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â container.style.borderColor = 'var(--accent-pink)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 5000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`ADMIN MESSAGE (${isError ? 'ERROR' : 'INFO'}):`, message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UTILIDADES DE IMAGEN (CARGA DESDE SUPABASE STORAGE) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function getPublicUrl(bucketName, filePath, fallbackUrl) {
Â  Â  Â  Â  Â  Â  if (!supabase) return fallbackUrl;

Â  Â  Â  Â  Â  Â  // 1. Obtener la URL pÃºblica de Supabase
Â  Â  Â  Â  Â  Â  const { data } = supabase.storage.from(bucketName).getPublicUrl(filePath);
Â  Â  Â  Â  Â  Â  let url = data?.publicUrl;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!url) return fallbackUrl;

Â  Â  Â  Â  Â  Â  // 2. Add Cache-Buster to force browser to load new version after upsert/update
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const parsedUrl = new URL(url);
Â  Â  Â  Â  Â  Â  Â  Â  const cacheBuster = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  parsedUrl.searchParams.set('v', cacheBuster);
Â  Â  Â  Â  Â  Â  Â  Â  url = parsedUrl.toString();

Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  const cacheBuster = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  const separator = url.includes('?') ? '&' : '?';
Â  Â  Â  Â  Â  Â  Â  Â  url = `${url}${separator}v=${cacheBuster}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return url;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadImages() {
Â  Â  Â  Â  Â  Â  // 1. Cargar Imagen de Fondo (Se aplica al CSS background-image)
Â  Â  Â  Â  Â  Â  const bgUrl = await getPublicUrl(
Â  Â  Â  Â  Â  Â  Â  Â  BACKGROUND_BUCKET_NAME,Â 
Â  Â  Â  Â  Â  Â  Â  Â  BACKGROUND_FILE_PATH,Â 
Â  Â  Â  Â  Â  Â  Â  Â  nullÂ 
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  // 2. Aplicar el fondo a la secciÃ³n hero
Â  Â  Â  Â  Â  Â  if (bgUrl && heroSection) {
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundImage = `url('${bgUrl}')`;
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundColor = 'transparent';Â 
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundSize = 'cover';
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundPosition = 'center bottom';

Â  Â  Â  Â  Â  Â  } else if (heroSection) {
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundImage = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  heroSection.style.backgroundColor = 'var(--dark-bg)'; // Color definido en CSS :root
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Cargar Imagen de Dispositivos (Se aplica al <img> src)
Â  Â  Â  Â  Â  Â  const devicesUrl = await getPublicUrl(
Â  Â  Â  Â  Â  Â  Â  Â  DEVICES_IMAGE_BUCKET_NAME,Â 
Â  Â  Â  Â  Â  Â  Â  Â  DEVICES_FILE_PATH,Â 
Â  Â  Â  Â  Â  Â  Â  Â  DEFAULT_DEVICES_IMAGE_URL
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (mainDevicesImage) {
Â  Â  Â  Â  Â  Â  Â  Â  mainDevicesImage.src = devicesUrl;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Funciones de subir y limpiar imagen (no se modifican)
Â  Â  Â  Â  async function uploadImage(fileInputId, bucketName, filePath, responseElementId) {Â 
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById(fileInputId);
Â  Â  Â  Â  Â  Â  const messageElement = document.getElementById(responseElementId);

Â  Â  Â  Â  Â  Â  if (!messageElement) { return; }Â 

Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];

Â  Â  Â  Â  Â  Â  if (!file) {
Â  Â  Â  Â  Â  Â  Â  Â  messageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  messageElement.textContent = 'Seleccione un archivo primero.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  messageElement.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  messageElement.textContent = 'Subiendo imagen...';

Â  Â  Â  Â  Â  Â  const { error: uploadError } = await supabase.storage
Â  Â  Â  Â  Â  Â  Â  Â  .from(bucketName)
Â  Â  Â  Â  Â  Â  Â  Â  .upload(filePath, file, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: trueÂ 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (uploadError) {
Â  Â  Â  Â  Â  Â  Â  Â  messageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError.status === 400 || (uploadError.message && uploadError.message.includes('row-level security'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageElement.textContent = 'ğŸš¨ Â¡Fallo de Seguridad (RLS 400)! Verifique que la polÃ­tica RLS de INSERT/UPDATE en el BUCKET DE STORAGE permita la subida al administrador.';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageElement.textContent = `Error al subir: ${uploadError.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al subir imagen:', uploadError);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  messageElement.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  messageElement.textContent = 'âœ… Imagen subida y actualizada con Ã©xito.';
Â  Â  Â  Â  Â  Â  await loadImages();
Â  Â  Â  Â  }
Â  Â  Â  Â  async function clearImage(bucketName, filePath, responseElementId, isBackground = false) {
Â  Â  Â  Â  Â  Â  Â const messageElement = document.getElementById(responseElementId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!messageElement) { return; }Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  messageElement.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  messageElement.textContent = 'Eliminando imagen...';

Â  Â  Â  Â  Â  Â  const { error: deleteError } = await supabase.storage
Â  Â  Â  Â  Â  Â  Â  Â  .from(bucketName)
Â  Â  Â  Â  Â  Â  Â  Â  .remove([filePath]);

Â  Â  Â  Â  Â  Â  if (deleteError && deleteError.statusCode !== '404') {
Â  Â  Â  Â  Â  Â  Â  Â  messageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  if (deleteError.status === 400 || (deleteError.message && deleteError.message.includes('row-level security'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageElement.textContent = 'ğŸš¨ Â¡Fallo de Seguridad (RLS 400)! Verifique que la polÃ­tica RLS de DELETE en el BUCKET DE STORAGE permita al administrador eliminar archivos.';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageElement.textContent = `Error al eliminar: ${deleteError.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al eliminar imagen:', deleteError);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  messageElement.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  messageElement.textContent = isBackgroundÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? 'Fondo de imagen eliminado y restaurado.'Â 
Â  Â  Â  Â  Â  Â  Â  Â  : 'Imagen de dispositivos restaurada por defecto.';
Â  Â  Â  Â  Â  Â  await loadImages();
Â  Â  Â  Â  }
Â  Â  Â  Â  async function handleUploadBackground() { await uploadImage('backgroundImageFile', BACKGROUND_BUCKET_NAME, BACKGROUND_FILE_PATH, 'backgroundResponseMessage'); }
Â  Â  Â  Â  async function handleClearBackground() { await clearImage(BACKGROUND_BUCKET_NAME, BACKGROUND_FILE_PATH, 'backgroundResponseMessage', true); }
Â  Â  Â  Â  async function handleUploadDevices() { await uploadImage('devicesImageFile', DEVICES_IMAGE_BUCKET_NAME, DEVICES_FILE_PATH, 'devicesImageResponseMessage'); }
Â  Â  Â  Â  async function handleClearDevices() { await clearImage(DEVICES_IMAGE_BUCKET_NAME, DEVICES_FILE_PATH, 'devicesImageResponseMessage', false); }


Â  Â  Â  Â  // --- SINCRONIZACIÃ“N DE SERVICIOS (MEJORADA PARA 3 CATEGORÃAS) ---

Â  Â  Â  Â  async function fetchServices() {
Â  Â  Â  Â  Â  Â  const loadingMessageIMEI = document.getElementById('loadingMessageIMEI');
Â  Â  Â  Â  Â  Â  if (loadingMessageIMEI) loadingMessageIMEI.textContent = 'Cargando servicios de todas las categorÃ­as...';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cargar los 3 records (ID 1, 2, 3)
Â  Â  Â  Â  Â  Â  const idsToFetch = Object.values(SERVICE_TYPES).map(type => type.id);

Â  Â  Â  Â  Â  Â  const { data, error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('store_services')Â 
Â  Â  Â  Â  Â  Â  Â  Â  .select('id, service_data')
Â  Â  Â  Â  Â  Â  Â  Â  .in('id', idsToFetch);

Â  Â  Â  Â  Â  Â  if (error) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar servicios de Supabase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  if (loadingMessageIMEI) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingMessageIMEI.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingMessageIMEI.textContent = `ERROR DE ACCESO: Verifique la polÃ­tica RLS (SELECT para anon) en 'store_services'. Error: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let loadedCount = 0;
Â  Â  Â  Â  Â  Â  let missingRecords = [];

Â  Â  Â  Â  Â  Â  // Mapear los datos cargados al serviceDataStore
Â  Â  Â  Â  Â  Â  Object.keys(SERVICE_TYPES).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  const serviceType = SERVICE_TYPES[key];
Â  Â  Â  Â  Â  Â  Â  Â  const record = data.find(r => r.id === serviceType.id);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (record && record.service_data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  serviceDataStore[key] = record.service_data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadedCount += record.service_data.length;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  serviceDataStore[key] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  missingRecords.push(serviceType.title);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (missingRecords.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Si faltan records, intentamos crearlos (solo si es Admin, pero se hace con ANON key por ahora)
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn(`Registros de servicios faltantes (${missingRecords.join(', ')}). Inicializando...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â await initializeMissingRecords(missingRecords);
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  if (loadingMessageIMEI) {
Â  Â  Â  Â  Â  Â  Â  Â  loadingMessageIMEI.textContent = `âœ… ${loadedCount} servicios cargados correctamente.`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function initializeMissingRecords(missingTitles) {
Â  Â  Â  Â  Â  Â  Â const updates = [];
Â  Â  Â  Â  Â  Â  Â Object.keys(SERVICE_TYPES).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (missingTitles.some(title => title === SERVICE_TYPES[key].title)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updates.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id: SERVICE_TYPES[key].id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â service_data: [] // Crea un array vacÃ­o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â if (updates.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .from('store_services')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .upsert(updates, { onConflict: 'id' });

Â  Â  Â  Â  Â  Â  Â  Â  Â if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error al inicializar records faltantes:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayAdminMessage(`Error al inicializar records (${missingTitles.join(', ')}). Verifique RLS de INSERT/UPDATE.`, 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â console.log(`Registros inicializados para: ${missingTitles.join(', ')}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â return false;
Â  Â  Â  Â  }

Â  Â  Â  Â Â 
Â  Â  Â  Â  async function updateServiceInSupabase(dataToSave, categoryKey) {
Â  Â  Â  Â  Â  Â  const editorMessageElement = document.getElementById('editorMessage') || document.getElementById('addServiceMessage') || document.getElementById('loadingMessageIMEI');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!editorMessageElement) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error: Elemento de mensaje de sincronizaciÃ³n no encontrado.");
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const recordId = SERVICE_TYPES[categoryKey].id;

Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `Guardando cambios en la categorÃ­a ${SERVICE_TYPES[categoryKey].title}...`;

Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('store_services')
Â  Â  Â  Â  Â  Â  Â  Â  .upsert([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: recordId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  service_data: dataToSave
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ], { onConflict: 'id' });

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error al guardar servicios (${categoryKey}) en Supabase:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `Error al guardar: ${error.message}. Verifique la polÃ­tica RLS (UPDATE/INSERT para admin) en 'store_services'.`;
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- FUNCIONES DE LA APLICACIÃ“N (GLOBAL) ---

Â  Â  Â  Â  function hideAllSections() {
Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (adminSection) adminSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (clientOrderHistorySection) clientOrderHistorySection.classList.add('hidden');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ocultar todas las secciones de servicios
Â  Â  Â  Â  Â  Â  if (imeiServiceSection) imeiServiceSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (boxDongleServiceSection) boxDongleServiceSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (digitalRentServiceSection) digitalRentServiceSection.classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * FunciÃ³n genÃ©rica para renderizar servicios en una secciÃ³n especÃ­fica.
Â  Â  Â  Â  Â * @param {string} categoryKey - 'imei', 'box-dongle', o 'digital-rent'.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderServices(categoryKey) {
Â  Â  Â  Â  Â  Â  const data = serviceDataStore[categoryKey] || [];
Â  Â  Â  Â  Â  Â  // Las IDs de los contenedores son diferentes
Â  Â  Â  Â  Â  Â  const containerId = `${categoryKey.replace(/-/g, '')}ServiceGridContainer`;
Â  Â  Â  Â  Â  Â  const section = document.getElementById(`${categoryKey.replace(/-/g, '')}ServiceSection`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!container || !section) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error(`Error al renderizar: Contenedor (${containerId}) o SecciÃ³n no encontrados.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  container.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<p style="color:orange;">No hay servicios cargados para ${SERVICE_TYPES[categoryKey].title}. Si eres administrador, usa el Panel para agregar tarjetas.</p>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  data.forEach(service => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'service-card';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.dataset.serviceId = service.id;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.dataset.serviceType = categoryKey; // Importante para el modal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isNew = service.name.toLowerCase().includes('nuevo');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${service.name.replace('Nuevo', '').trim()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isNew ? `<span class="new-tag">Nuevo</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="card-icon-check">âœ…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  CategorÃ­a: <strong>${service.category}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="price">${service.price}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="time">${service.time.replace('Miniutes', 'Minutos').replace('Hours', 'Horas').replace('days', 'dÃ­as')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(card);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Asegurar que solo los cards de esta secciÃ³n tengan el listener
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`#${containerId} .service-card`).forEach(card => {
Â  Â  Â  Â  Â  Â  Â  Â  // Eliminar cualquier listener previo para evitar duplicados
Â  Â  Â  Â  Â  Â  Â  Â  card.removeEventListener('click', openOrderModal);Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.addEventListener('click', openOrderModal);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  section.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  }


Â  Â  Â  Â  function displayOrders(containerElement, orders, isAdminView = false) {
Â  Â  Â  Â  Â  Â  Â containerElement.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (orders.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  containerElement.innerHTML = '<p>No hay pedidos registrados en su historial.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  orders.forEach(order => {
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = `order-card ${order.status.replace(/[^a-zA-Z0-9]/g, '')}`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.dataset.orderId = order.id;

Â  Â  Â  Â  Â  Â  Â  Â  const statusOptions = ['Pendiente', 'Exitoso', 'Rechazado'];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let orderActionsHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (isAdminView) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: El select llama a la funciÃ³n global window.updateOrderStatus
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderActionsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="window.updateOrderStatus(${order.id}, this.value)">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusOptions.map(status => `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="admin-order-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.deleteOrder(${order.id})">Eliminar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderActionsHtml = `<span class="status-badge ${order.status.replace(/[^a-zA-Z0-9]/g, '')}">${order.status}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let extraDetails = isAdminView ? `<p><strong>Cliente:</strong> ${order.client_name || 'N/A'}</p><p><strong>WhatsApp:</strong> ${order.whatsapp || 'N/A'}</p>` : '';


Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Servicio:</strong> ${order.service_name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>SN/IMEI:</strong> ${order.device_name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${extraDetails}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdminView ? `<p><strong>Contacto Email:</strong> ${order.contact_email}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 10px; color: #777;">Pedido: ${new Date(order.created_at).toLocaleString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${orderActionsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  containerElement.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funciones de historial (se dejan en el script para completar)
Â  Â  Â  Â  async function fetchAdminOrdersHistory() {
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('adminOrderHistory');
Â  Â  Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  displayAdminMessage('Cargando historial de todos los pedidos...', 'yellow', false);

Â  Â  Â  Â  Â  Â  const { data: orders, error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('orders')
Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false });

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`âŒ Error al cargar pedidos del Admin: ${error.message}. AsegÃºrese de que RLS (SELECT para autenticados) estÃ© configurado para ver todos los pedidos (auth.email() = '${ADMIN_EMAIL}').`, 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("RLS/API Error al cargar pedidos del Admin:", error);
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<p style="color: red;">No se pudieron cargar los pedidos. Verifique el mensaje de error de RLS arriba.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  displayAdminMessage(`âœ… ${orders.length} pedidos cargados.`, 'var(--whatsapp-green)', false);
Â  Â  Â  Â  Â  Â  displayOrders(container, orders, true);
Â  Â  Â  Â  }
Â  Â  Â  Â  async function fetchClientOrdersHistory() {
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('clientOrderHistoryContainer');
Â  Â  Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.innerHTML = '<p>Cargando su historial de pedidos...</p>';

Â  Â  Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<p style="color:red;">No ha iniciado sesiÃ³n.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const userId = currentUser.id;

Â  Â  Â  Â  Â  Â  const { data: orders, error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('orders')
Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  .eq('user_id', userId)Â 
Â  Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false });

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<p style="color:red;">Error al cargar su historial: ${error.message}. AsegÃºrese de que RLS (SELECT para autenticados) estÃ© configurado en 'orders' permitiendo ver solo sus propios pedidos (user_id = auth.uid()).</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  displayOrders(container, orders, false);

Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  if (clientOrderHistorySection) clientOrderHistorySection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  }
Â  Â  Â  Â  window.updateOrderStatus = async function(orderId, newStatus) {
Â  Â  Â  Â  Â  Â  Â displayAdminMessage(`Actualizando pedido #${orderId} a ${newStatus}...`, 'yellow', false);

Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('orders')
Â  Â  Â  Â  Â  Â  Â  Â  .update({ status: newStatus })
Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', orderId);

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`Error al actualizar estado: ${error.message}. Revise los permisos RLS de UPDATE.`, 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`âœ… Estado de pedido #${orderId} actualizado a ${newStatus}.`, 'var(--whatsapp-green)', false);
Â  Â  Â  Â  Â  Â  Â  Â  fetchAdminOrdersHistory();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.executeDeleteOrder = async function(orderId) {
Â  Â  Â  Â  Â  Â  Â displayAdminMessage(`Eliminando pedido #${orderId} permanentemente...`, 'yellow', false);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const msgEl = document.getElementById('adminOrderHistoryMessage');
Â  Â  Â  Â  Â  Â  if (msgEl) {
Â  Â  Â  Â  Â  Â  Â  Â  msgEl.onclick = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  msgEl.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('orders')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .delete()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', orderId);

Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`âŒ Error al eliminar pedido #${orderId}: ${error.message}. **VERIFIQUE RLS DE DELETE** en la tabla 'orders' para el ADMIN.`, 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al eliminar pedido (RLS o API):", error);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`ğŸ—‘ï¸ Pedido #${orderId} eliminado con Ã©xito.`, 'var(--whatsapp-green)', false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchAdminOrdersHistory();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  const genericErrorMessage = `Error de red/seguridad: ${e.message}. Esto a menudo indica que RLS estÃ¡ bloqueando la solicitud o un problema de red. Por favor, asegÃºrese de que la polÃ­tica RLS de DELETE estÃ¡ habilitada para el Administrador.`;
Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage(`âŒ Error al eliminar pedido #${orderId}: ${genericErrorMessage}`, 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error de red/fetch al eliminar pedido:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.deleteOrder = function(orderId) {
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('adminOrderHistoryMessage');
Â  Â  Â  Â  Â  Â  if (!container) return;

Â  Â  Â  Â  Â  Â  const confirmationHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-bottom: 10px; color: var(--orange-pending);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âš ï¸ **CONFIRME**: Â¿EstÃ¡ seguro de eliminar el Pedido #${orderId}? Â¡Esta acciÃ³n es irreversible!
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.executeDeleteOrder(${orderId});"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="background-color: var(--red-error); color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Confirmar EliminaciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('adminOrderHistoryMessage').innerHTML='';"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="background-color: var(--button-bg); color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Cancelar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.style.color = 'var(--text-light)';
Â  Â  Â  Â  Â  Â  container.style.borderColor = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  container.innerHTML = confirmationHTML;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 

Â  Â  Â  Â  // --- LÃ“GICA DEL MODAL DE PEDIDO (ACTUALIZADA) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function openOrderModal(event) {
Â  Â  Â  Â  Â  Â  const serviceId = event.currentTarget.dataset.serviceId;
Â  Â  Â  Â  Â  Â  const serviceType = event.currentTarget.dataset.serviceType; // Nuevo: obtener el tipo de servicio
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Buscar el servicio en el almacÃ©n de datos correcto
Â  Â  Â  Â  Â  Â  const serviceList = serviceDataStore[serviceType] || [];
Â  Â  Â  Â  Â  Â  const service = serviceList.find(s => s.id == serviceId);

Â  Â  Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--orange-pending)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Inicia sesiÃ³n para realizar un pedido.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const user = currentUser;Â 

Â  Â  Â  Â  Â  Â  if (!service) return;

Â  Â  Â  Â  Â  Â  document.getElementById('modalServiceName').textContent = `Pedido: ${service.name}`;
Â  Â  Â  Â  Â  Â  document.getElementById('modalEmail').value = user.email || '';
Â  Â  Â  Â  Â  Â  document.getElementById('modalSerial').value = '';Â 
Â  Â  Â  Â  Â  Â  document.getElementById('modalClientName').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('modalWhatsapp').value = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('modalServiceId').value = service.id;
Â  Â  Â  Â  Â  Â  document.getElementById('modalServiceType').value = serviceType; // Guardar el tipo de servicio en el hidden input

Â  Â  Â  Â  Â  Â  if (document.getElementById('modalMessage')) document.getElementById('modalMessage').textContent = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('orderModal')) document.getElementById('orderModal').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function submitBypassOrder() {
Â  Â  Â  Â  Â  Â  const sn = document.getElementById('modalSerial').value.trim();
Â  Â  Â  Â  Â  Â  const email = document.getElementById('modalEmail').value.trim();
Â  Â  Â  Â  Â  Â  const clientName = document.getElementById('modalClientName').value.trim();
Â  Â  Â  Â  Â  Â  const whatsapp = document.getElementById('modalWhatsapp').value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const serviceId = document.getElementById('modalServiceId').value;
Â  Â  Â  Â  Â  Â  const serviceType = document.getElementById('modalServiceType').value; // Obtener el tipo de servicio
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Buscar el servicio en el almacÃ©n de datos correcto
Â  Â  Â  Â  Â  Â  const serviceList = serviceDataStore[serviceType] || [];
Â  Â  Â  Â  Â  Â  const service = serviceList.find(s => s.id == serviceId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const user = currentUser;

Â  Â  Â  Â  Â  Â  const modalMessage = document.getElementById('modalMessage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = 'Error de sesiÃ³n. Por favor, vuelva a iniciar sesiÃ³n.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!sn || !email || !clientName || !whatsapp) {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = 'Complete todos los campos (Nombre, WhatsApp, SN/IMEI, Email).';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!service) {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Error: Servicio de tipo ${serviceType} no encontrado.`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = 'Enviando orden...';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('orders')
Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: user.id,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  service_id: serviceId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  service_type: serviceType, // Nuevo campo en orders
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  service_name: service.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  device_name: sn,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imei: sn,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contact_email: email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  client_name: clientName,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  whatsapp: whatsapp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'Pendiente',Â 
Â  Â  Â  Â  Â  Â  Â  Â  }]);

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.status === 429) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = 'Error 429 (Too Many Requests). La API estÃ¡ sobrecargada. Por favor, espere un momento antes de intentarlo de nuevo.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Error: ${error.message}. Revise sus polÃ­ticas RLS de INSERT en la tabla 'orders'.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `âœ… Â¡Pedido de ${service.name} enviado con Ã©xito!`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('orderModal')) document.getElementById('orderModal').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchClientOrdersHistory();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- LÃ“GICA DE ADMINISTRACIÃ“N DE SERVICIOS (ACTUALIZADA) ---

Â  Â  Â  Â  async function addNewService(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();Â 

Â  Â  Â  Â  Â  Â  const categoryKey = currentEditingCategory; // Usar la categorÃ­a activa
Â  Â  Â  Â  Â  Â  const dataList = serviceDataStore[categoryKey];

Â  Â  Â  Â  Â  Â  const name = document.getElementById('newServiceName').value.trim();
Â  Â  Â  Â  Â  Â  const price = document.getElementById('newServicePrice').value.trim();
Â  Â  Â  Â  Â  Â  const time = document.getElementById('newServiceTime').value.trim();
Â  Â  Â  Â  Â  Â  const category = document.getElementById('newServiceCategory').value.trim();

Â  Â  Â  Â  Â  Â  if (!name || !price || !time || !category) {
Â  Â  Â  Â  Â  Â  Â  Â  if (addServiceMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.textContent = 'Todos los campos deben ser completados.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (addServiceMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.textContent = 'AÃ±adiendo servicio...';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nextId = dataList.length > 0
Â  Â  Â  Â  Â  Â  Â  Â  ? Math.max(...dataList.map(s => s.id)) + 1Â 
Â  Â  Â  Â  Â  Â  Â  Â  : 1;

Â  Â  Â  Â  Â  Â  const newService = {
Â  Â  Â  Â  Â  Â  Â  Â  id: nextId,
Â  Â  Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  Â  Â  price: price.startsWith('$') ? price : `$${price}`,
Â  Â  Â  Â  Â  Â  Â  Â  time: time,
Â  Â  Â  Â  Â  Â  Â  Â  category: category
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  dataList.push(newService);

Â  Â  Â  Â  Â  Â  const success = await updateServiceInSupabase(dataList, categoryKey);

Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  if (addServiceMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addServiceMessage.textContent = `âœ… Servicio "${newService.name.substring(0, 30)}..." aÃ±adido a ${SERVICE_TYPES[categoryKey].title} y guardado!`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('newServiceForm')) document.getElementById('newServiceForm').reset();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderServiceEditor();Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (addServiceMessage) addServiceMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  dataList.pop();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  function renderServiceEditor() {
Â  Â  Â  Â  Â  Â  const editorList = document.getElementById('serviceEditorList');
Â  Â  Â  Â  Â  Â  if (!editorList) return;

Â  Â  Â  Â  Â  Â  const categoryKey = currentEditingCategory;
Â  Â  Â  Â  Â  Â  const dataList = serviceDataStore[categoryKey];
Â  Â  Â  Â  Â  Â  const categoryTitle = SERVICE_TYPES[categoryKey].title;

Â  Â  Â  Â  Â  Â  editorList.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  editorMessage = document.getElementById('editorMessage');
Â  Â  Â  Â  Â  Â  if (!editorMessage) return;

Â  Â  Â  Â  Â  Â  // Actualizar botÃ³n de AÃ±adir
Â  Â  Â  Â  Â  Â  document.getElementById('currentCategoryAddBtn').textContent = categoryTitle;

Â  Â  Â  Â  Â  Â  editorMessage.textContent = `Lista de EdiciÃ³n para: ${categoryTitle}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (dataList.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  editorList.innerHTML = `<p style="color:orange; padding: 10px; text-align: center;">No hay servicios para editar en ${categoryTitle}. Usa la secciÃ³n "AÃ±adir Nuevo Servicio RÃ¡pido" para empezar.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  dataList.forEach((service) => {
Â  Â  Â  Â  Â  Â  Â  Â  const listItem = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: El botÃ³n de eliminar llama a la funciÃ³n global window.deleteService
Â  Â  Â  Â  Â  Â  Â  Â  listItem.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 1; margin-right: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Nombre Completo (ID: ${service.id}):</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name-${service.id}" value="${service.name.replace(/"/g, '&quot;')}" data-field="name" data-id="${service.id}" class="full-name-input" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Precio:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="price-${service.id}" value="${service.price}" data-field="price" data-id="${service.id}" style="width: 80px;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Tiempo:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="time-${service.id}" value="${service.time}" data-field="time" data-id="${service.id}" style="width: 100px;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Sub-CategorÃ­a:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="category-${service.id}" value="${service.category}" data-field="category" data-id="${service.id}" style="width: 120px;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="service-editor-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.deleteService(${service.id})">Eliminar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  listItem.classList.add('service-editor-item');
Â  Â  Â  Â  Â  Â  Â  Â  editorList.appendChild(listItem);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (editorMessage) editorMessage.textContent = `${dataList.length} servicios listados para ${categoryTitle}.`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FIX: Se adjunta al objeto window para ser accesible desde el atributo onclick del HTML.
Â  Â  Â  Â  window.deleteService = function(id) {
Â  Â  Â  Â  Â  Â  const categoryKey = currentEditingCategory;
Â  Â  Â  Â  Â  Â  let dataList = serviceDataStore[categoryKey];

Â  Â  Â  Â  Â  Â  // Filtrar y actualizar el array localmente
Â  Â  Â  Â  Â  Â  serviceDataStore[categoryKey] = dataList.filter(s => s.id !== id);

Â  Â  Â  Â  Â  Â  renderServiceEditor();Â 
Â  Â  Â  Â  Â  Â  if (editorMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  editorMessage.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  Â  Â  editorMessage.textContent = `Servicio ID ${id} eliminado de la lista local de ${SERVICE_TYPES[categoryKey].title}. Pulse GUARDAR para sincronizar.`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function clearAllServices() {
Â  Â  Â  Â  Â  Â  const categoryKey = currentEditingCategory;
Â  Â  Â  Â  Â  Â  const editorMessageElement = document.getElementById('editorMessage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!editorMessageElement) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error: Elemento de mensaje del editor no encontrado.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!confirm(`ğŸš¨ Â¿EstÃ¡ SEGURO que desea ELIMINAR TODOS los servicios de la categorÃ­a "${SERVICE_TYPES[categoryKey].title}"? Esta acciÃ³n es IRREVERSIBLE.`)) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `Eliminando todos los servicios de ${SERVICE_TYPES[categoryKey].title}...`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  serviceDataStore[categoryKey] = [];Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const success = await updateServiceInSupabase([], categoryKey);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `âœ… Â¡Todos los servicios de ${SERVICE_TYPES[categoryKey].title} eliminados y sincronizados con Ã©xito!`;
Â  Â  Â  Â  Â  Â  Â  Â  renderServiceEditor();Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderizar la vista de cliente para reflejar cambios inmediatamente
Â  Â  Â  Â  Â  Â  Â  Â  renderServices(categoryKey);Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function saveServiceChanges() {
Â  Â  Â  Â  Â  Â  const categoryKey = currentEditingCategory;
Â  Â  Â  Â  Â  Â  const editorMessageElement = document.getElementById('editorMessage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!editorMessageElement) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error: Elemento de mensaje del editor no encontrado.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `Guardando cambios en ${SERVICE_TYPES[categoryKey].title}...`;

Â  Â  Â  Â  Â  Â  const updatedData = [];
Â  Â  Â  Â  Â  Â  const serviceEditorList = document.getElementById('serviceEditorList');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Recoger datos del DOM (ya actualizados por la lÃ³gica de ediciÃ³n)
Â  Â  Â  Â  Â  Â  serviceEditorList.querySelectorAll('.service-editor-item').forEach(listItem => {
Â  Â  Â  Â  Â  Â  Â  Â  const id = parseInt(listItem.querySelector('input[data-field="name"]').dataset.id);
Â  Â  Â  Â  Â  Â  Â  Â  const nameInput = listItem.querySelector(`#name-${id}`).value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const priceInput = listItem.querySelector(`#price-${id}`).value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const timeInput = listItem.querySelector(`#time-${id}`).value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const categoryInput = listItem.querySelector(`#category-${id}`).value.trim();

Â  Â  Â  Â  Â  Â  Â  Â  updatedData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: nameInput,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: priceInput,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: timeInput,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: categoryInput
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const success = await updateServiceInSupabase(updatedData, categoryKey);

Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  serviceDataStore[categoryKey] = updatedData; // Sincronizar el store local
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.textContent = `âœ… Â¡Cambios guardados y sincronizados con Ã©xito en ${SERVICE_TYPES[categoryKey].title}!`;
Â  Â  Â  Â  Â  Â  Â  Â  renderServiceEditor();Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderServices(categoryKey); // Forzar recarga de tarjetas de cliente
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  editorMessageElement.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  async function checkUser(userSession) {
Â  Â  Â  Â  Â  Â  const user = userSession?.user;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  currentUser = user || null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  hideAllSections();

Â  Â  Â  Â  Â  Â  if (navAdminPanel) navAdminPanel.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (adminNameDisplay) adminNameDisplay.classList.add('hidden');

Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  const isAdmin = user.email === ADMIN_EMAIL;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (loginLogoutBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginLogoutBtn.textContent = 'Logout';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginLogoutBtn.onclick = signOut;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isAdmin) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (navAdminPanel) navAdminPanel.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (adminNameDisplay) adminNameDisplay.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loggedInUserName) loggedInUserName.textContent = 'Admin';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (adminNameDisplay) adminNameDisplay.textContent = `(${user.email})`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mostrar la secciÃ³n Hero por defecto, a menos que ya se estÃ© mostrando una secciÃ³n de servicio.
Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (loginLogoutBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginLogoutBtn.textContent = 'Login / Register';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginLogoutBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Si no hay ninguna secciÃ³n activa, mostrar Hero (lÃ³gica redundante, pero segura)
Â  Â  Â  Â  Â  Â  if (document.querySelectorAll('section:not(.hidden)').length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (heroSection) heroSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleNavigationClick(event) {
Â  Â  Â  Â  Â  Â  const clickedElement = event.currentTarget;
Â  Â  Â  Â  Â  Â  if (!clickedElement || !clickedElement.id) { return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const elementId = clickedElement.id;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ocultar el menÃº desplegable si se hace clic en otro elemento de la barra de navegaciÃ³n.
Â  Â  Â  Â  Â  Â  if (elementId !== 'navPongaOrden') {
Â  Â  Â  Â  Â  Â  Â  Â  if (pongaOrdenMenu) pongaOrdenMenu.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isLoggedIn = !!currentUser;Â 
Â  Â  Â  Â  Â  Â  const isAdmin = isLoggedIn && currentUser.email === ADMIN_EMAIL;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let shouldScrollToTop = true;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switch (elementId) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'navPongaOrden':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLoggedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CORREGIDO: Solo alternar la visibilidad del menÃº.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pongaOrdenMenu) pongaOrdenMenu.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shouldScrollToTop = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Asegurar que hero se vea si el menÃº se oculta o si el menÃº estÃ¡ visible sin secciÃ³n de servicio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--orange-pending)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Inicia sesiÃ³n o regÃ­strate para ver las opciones de Ã³rdenes.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'navAdminPanel':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetchServices(); // Refrescar todos los datos de servicios
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchAdminOrdersHistory();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderServiceEditor(); // Renderizar el editor con la categorÃ­a activa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (adminSection) adminSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isLoggedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayAdminMessage('No tienes permisos de administrador para acceder a este panel.', 'var(--red-error)', true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'navHistorialPedidos':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLoggedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchAdminOrdersHistory();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (adminSection) adminSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchClientOrdersHistory();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Inicia sesiÃ³n para ver tu historial de pedidos.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--orange-pending)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'navAreaCliente':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLoggedIn) { if (heroSection) heroSection.classList.remove('hidden'); } else { if (loginSection) loginSection.classList.remove('hidden'); if (loginSection) loginSection.scrollIntoView({ behavior: 'smooth' }); if (loginMessage) loginMessage.textContent = ''; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (shouldScrollToTop) {
Â  Â  Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Funciones de Auth (no se modifican)
Â  Â  Â  Â  async function signInWithEmail() {Â 
Â  Â  Â  Â  Â  Â  Â const email = document.getElementById('loginEmail').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('loginPassword').value;

Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Iniciando sesiÃ³n...';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!supabase) { if (loginMessage) { loginMessage.style.color = 'var(--red-error)'; loginMessage.textContent = 'Error de inicializaciÃ³n de la API.'; } return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al hacer login:', error);
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) loginMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  let msg = error.message;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error.status === 429) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = 'â›” LÃ­mite de solicitudes alcanzado (Error 429). Por favor, espera 60 segundos antes de volver a intentarlo.';
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (error.message.includes('Invalid login credentials')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = 'âŒ Credenciales de inicio de sesiÃ³n invÃ¡lidas. Comprueba el correo y la contraseÃ±a.';Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (error.message.includes('Email not confirmed')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = 'ğŸ“§ Correo electrÃ³nico no confirmado. Por favor, revisa tu bandeja de entrada.';Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) loginMessage.textContent = `Error de inicio: ${msg}`;
Â  Â  Â  Â  Â  Â  } else if (data.user) {
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--whatsapp-green)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'âœ… SesiÃ³n iniciada con Ã©xito! Redirigiendo...';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Error desconocido. Comprueba la confirmaciÃ³n del correo.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function signUpWithEmail() {Â 
Â  Â  Â  Â  Â  Â  Â const email = document.getElementById('loginEmail').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('loginPassword').value;

Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'yellow';
Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Registrando usuario...';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!supabase) { if (loginMessage) { loginMessage.style.color = 'var(--red-error)'; loginMessage.textContent = 'Erro de inicializaciÃ³n de la API.'; } return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const { error } = await supabase.auth.signUp({ email, password });
Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al registrar:', error);
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--red-error)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = `Error: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = '#4dc2f2';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'âœ… Registro exitoso! Por favor, revisa tu correo para confirmar tu cuenta antes de iniciar sesiÃ³n.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function signOut() {Â 
Â  Â  Â  Â  Â  Â  if (!supabase) return;
Â  Â  Â  Â  Â  Â  const { error } = await supabase.auth.signOut();
Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al hacer logout:', error);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) loginMessage.textContent = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- InicializaciÃ³n (IIFE para evitar Race Condition) ---
Â  Â  Â  Â  (async function initApp() {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if ('scrollRestoration' in history) {
Â  Â  Â  Â  Â  Â  Â  Â  history.scrollRestoration = 'manual';Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (window.supabase) {
Â  Â  Â  Â  Â  Â  Â  Â  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error: La biblioteca Supabase no fue cargada. Verifique el link CDN.");
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Mapeo de Elementos DOM
Â  Â  Â  Â  Â  Â  heroSection = document.getElementById('heroSection');
Â  Â  Â  Â  Â  Â  mainDevicesImage = document.getElementById('mainDevicesImage');
Â  Â  Â  Â  Â  Â  loginSection = document.getElementById('loginSection');
Â  Â  Â  Â  Â  Â  adminSection = document.getElementById('adminSection');
Â  Â  Â  Â  Â  Â  // Mapeo de las 3 secciones
Â  Â  Â  Â  Â  Â  imeiServiceSection = document.getElementById('imeiServiceSection');Â 
Â  Â  Â  Â  Â  Â  boxDongleServiceSection = document.getElementById('boxDongleServiceSection');Â 
Â  Â  Â  Â  Â  Â  digitalRentServiceSection = document.getElementById('digitalRentServiceSection');Â 
Â  Â  Â  Â  Â  Â  clientOrderHistorySection = document.getElementById('clientOrderHistorySection');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadingMessage = document.getElementById('loadingMessageIMEI');Â 
Â  Â  Â  Â  Â  Â  editorMessage = document.getElementById('editorMessage');Â 
Â  Â  Â  Â  Â  Â  adminOrderHistory = document.getElementById('adminOrderHistory');Â 
Â  Â  Â  Â  Â  Â  clientOrderHistoryContainer = document.getElementById('clientOrderHistoryContainer');
Â  Â  Â  Â  Â  Â  addServiceMessage = document.getElementById('addServiceMessage');
Â  Â  Â  Â  Â  Â  adminOrderHistoryMessage = document.getElementById('adminOrderHistoryMessage');

Â  Â  Â  Â  Â  Â  loginLogoutBtn = document.getElementById('loginLogoutBtn');
Â  Â  Â  Â  Â  Â  loggedInUserName = document.getElementById('loggedInUserName');
Â  Â  Â  Â  Â  Â  adminNameDisplay = document.getElementById('adminNameDisplay');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  navAreaCliente = document.getElementById('navAreaCliente');
Â  Â  Â  Â  Â  Â  navPongaOrden = document.getElementById('navPongaOrden');
Â  Â  Â  Â  Â  Â  navHistorialPedidos = document.getElementById('navHistorialPedidos');
Â  Â  Â  Â  Â  Â  pongaOrdenMenu = document.getElementById('pongaOrdenMenu');Â 
Â  Â  Â  Â  Â  Â  navAdminPanel = document.getElementById('navAdminPanel');Â 

Â  Â  Â  Â  Â  Â  backgroundResponseMessage = document.getElementById('backgroundResponseMessage');
Â  Â  Â  Â  Â  Â  devicesImageResponseMessage = document.getElementById('devicesImageResponseMessage');
Â  Â  Â  Â  Â  Â  loginMessage = document.getElementById('loginMessage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CARGA DE IMAGENES (Persistente) ---
Â  Â  Â  Â  Â  Â  await loadImages();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CARGA DE DATOS ---
Â  Â  Â  Â  Â  Â  await fetchServices();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Listeners de AutenticaciÃ³n y Modal
Â  Â  Â  Â  Â  Â  document.getElementById('signInButton').addEventListener('click', signInWithEmail);
Â  Â  Â  Â  Â  Â  document.getElementById('signUpButton').addEventListener('click', signUpWithEmail);
Â  Â  Â  Â  Â  Â  document.getElementById('closeModal').addEventListener('click', () => { if (document.getElementById('orderModal')) document.getElementById('orderModal').classList.add('hidden'); });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('submitModalOrder').addEventListener('click', submitBypassOrder);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Listeners de NavegaciÃ³n y Admin
Â  Â  Â  Â  Â  Â  document.getElementById('saveServiceChanges').addEventListener('click', saveServiceChanges);
Â  Â  Â  Â  Â  Â  document.getElementById('clearAllServicesButton').addEventListener('click', clearAllServices);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('newServiceForm').addEventListener('submit', addNewService);Â 
Â  Â  Â  Â  Â  Â  navAreaCliente.addEventListener('click', handleNavigationClick);
Â  Â  Â  Â  Â  Â  // CORREGIDO: navPongaOrden solo debe alternar el menÃº y asegurar que la hero section no se oculte al abrirlo
Â  Â  Â  Â  Â  Â  navPongaOrden.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const isLoggedIn = !!currentUser;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isLoggedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pongaOrdenMenu) pongaOrdenMenu.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pongaOrdenMenu?.classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si se cierra el menÃº, se muestra la hero section si no hay otra secciÃ³n abierta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Asegurar que la hero section se muestre si no hay una secciÃ³n de servicio activa (solo para fines visuales)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (heroSection) heroSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si no estÃ¡ logueado, redirige a login y muestra mensaje.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleNavigationClick(e); // Llama al manejador para la lÃ³gica de login/redirect
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  navHistorialPedidos.addEventListener('click', handleNavigationClick);
Â  Â  Â  Â  Â  Â  navAdminPanel.addEventListener('click', handleNavigationClick);Â 

Â  Â  Â  Â  Â  Â  // Listeners de GestiÃ³n de ImÃ¡genes
Â  Â  Â  Â  Â  Â  document.getElementById('uploadBackgroundButton').addEventListener('click', handleUploadBackground);
Â  Â  Â  Â  Â  Â  document.getElementById('clearBackgroundButton').addEventListener('click', handleClearBackground);
Â  Â  Â  Â  Â  Â  document.getElementById('uploadDevicesButton').addEventListener('click', handleUploadDevices);
Â  Â  Â  Â  Â  Â  document.getElementById('clearDevicesButton').addEventListener('click', handleClearDevices);

Â  Â  Â  Â  Â  Â  // NUEVO: Listener para el selector de categorÃ­a en el Admin
Â  Â  Â  Â  Â  Â  const categorySelector = document.getElementById('serviceCategorySelector');
Â  Â  Â  Â  Â  Â  if (categorySelector) {
Â  Â  Â  Â  Â  Â  Â  Â  categorySelector.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentEditingCategory = e.target.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderServiceEditor();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // CORRECCIÃ“N CLAVE: Este listener ahora maneja la visualizaciÃ³n de la secciÃ³n
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.order-type-link').forEach(link => {
Â  Â  Â  Â  Â  Â  Â  Â  link.addEventListener('click', function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pongaOrdenMenu) pongaOrdenMenu.classList.add('hidden'); // Ocultar menÃº inmediatamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const serviceType = this.dataset.serviceType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginSection) loginSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loginMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.textContent = 'Inicia sesiÃ³n para ver los servicios.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginMessage.style.color = 'var(--orange-pending)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CORRECCIÃ“N: Llamar a la funciÃ³n genÃ©rica de renderizado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderServices(serviceType);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // PASO CRÃTICO: Obtener la sesiÃ³n inicial y usar el listener para las actualizaciones.
Â  Â  Â  Â  Â  Â  const { data: { session } } = await supabase.auth.getSession();
Â  Â  Â  Â  Â  Â  checkUser(session);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Establecer la secciÃ³n por defecto al cargar (IMEI Service si estÃ¡ logueado, sino Hero)
Â  Â  Â  Â  Â  Â  if (currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  Â renderServices('imei');
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  supabase.auth.onAuthStateChange((event, session) => {
Â  Â  Â  Â  Â  Â  Â  Â  checkUser(session);
Â  Â  Â  Â  Â  Â  Â  Â  // Si el usuario acaba de iniciar sesiÃ³n, redirigirlo a la secciÃ³n IMEI por defecto
Â  Â  Â  Â  Â  Â  Â  Â  if (session && event === 'SIGNED_IN') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderServices('imei');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  })();
Â  Â  </script>
</body>
</html>
